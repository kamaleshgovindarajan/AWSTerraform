variables.tf

variable "environment" {
  default = "dev"
  type = string
}
variable "instance_type" {
  type = list(string)
  default = ["t3.large", "t3.medium", "t3.micro", "t2.micro"]
}
variable "ingress_rules" {
  type = list(object({
    from_port = number
    to_port = number
    protocol = string
    cidr_blocks = list(string)
    description = string
  }))
  default = [ 
    {
      from_port = 80
      to_port = 80
      protocol = "http"
      cidr_blocks = ["0.0.0.0/0"]
      description = "ingress rule port 80"
    },
    {
      from_port = 443
      to_port = 443
      protocol = "http"
      cidr_blocks = ["0.0.0.0/0"]
      description = "ingress rule 443"
    }
  ] 
}
---

main.tf

resource "aws_instance" "example" {
  ami          = "ami-0c55b159cbfafe1f0"
  count        = var.instance_count
  instance_type = var.environment == "dev" ? var.instance_type[3] : var.instance_type[2]

  tags = var.tags
}

resource "aws_security_group" "ingress" {

  dynamic "ingress" {
    for_each =var.ingress_rules
    content{
    from_port       = ingress.value.from_port
    to_port         = ingress.value.to_port
    protocol        = ingress.value.protocol
    cidr_blocks     = ingress.value.cidr_blocks
    }
  }
}

---

locals.tf

locals {
     all_instance_id = aws_instance.example[*].region
}

---

output.tf

output "instances" {
    value = local.all_instance_id
}
---
