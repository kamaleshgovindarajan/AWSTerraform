# For prevent_destroy and ignore_changes
main.tf

resource "aws_instance" "web_server" {
  ami           = "ami-0f00d706c4a80fd93"
  instance_type = var.instance_type[2]
  monitoring = true

  tags = merge(
    var.tags,
    {
      Name = "development-test-instance"
    }
  )

  # Lifecycle Rule: Create new instance before destroying the old one
  # This ensures zero downtime during instance updates (e.g., changing AMI or instance type)
  lifecycle {
    create_before_destroy = true
    ignore_changes = [
      monitoring
    ]
    prevent_destroy = true
  }
}
---

variable.tf
variable "instance_type" {
  type = list(string)
  default = ["t3.large", "t3.medium", "t3.micro"]
}

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#For replace_triggered_by, post_condition, create_before_destroy

resource "aws_security_group" "allow_tls" {
  name        = "allow_sg_rule"
  description = "Allow TLS inbound traffic and all outbound traffic"

  tags = {
    Name = "allow_tls"
  }
}

resource "aws_vpc_security_group_ingress_rule" "allow_tls_ipv4" {
  security_group_id = aws_security_group.allow_tls.id
  cidr_ipv4         = "0.0.0.0/0"
  from_port         = 80
  ip_protocol       = "tcp"
  to_port           = 80
}


resource "aws_vpc_security_group_egress_rule" "allow_all_traffic_ipv4" {
  security_group_id = aws_security_group.allow_tls.id
  cidr_ipv4         = "0.0.0.0/0"
  ip_protocol       = "-1" # semantically equivalent to all ports
}



resource "aws_instance" "web_server" {
  ami           = "ami-0f00d706c4a80fd93"
  instance_type = var.instance_type[2]
  monitoring = true
  vpc_security_group_ids = [ aws_security_group.allow_tls.id ]

  tags = merge(
    var.tags,
    {
      Name = "development-test-instance"
      Demo = "create_before_destroy"
    }
  )

  # Lifecycle Rule: Create new instance before destroying the old one
  # This ensures zero downtime during instance updates (e.g., changing AMI or instance type)
  lifecycle {
    postcondition {
      condition = contains (keys (var.tags), "compliance")
      error_message = "Tag 'compliance' is required."
    }
    create_before_destroy = true
    replace_triggered_by = [
      aws_security_group.allow_tls.id
    ]
    ignore_changes = [
      monitoring
    ]
  }
  
}


